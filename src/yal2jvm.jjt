options{

	MULTI=true;
}

PARSER_BEGIN(yal2jvm)
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.InputStream;
import java.util.*;

public class yal2jvm {
	public static int error_counter = 0;
	private static SimpleNode astRoot = null;
	public static void main(String args[]) throws ParseException {
		InputStream f = null;

		try { 
			f = new FileInputStream("/home/delay/FEUP/comp-bit/g33/yal examples/" + args[0]);
		}catch(FileNotFoundException e) {
			System.out.println(e.getMessage());
		}

		System.out.println("File: " + args[0]);

		yal2jvm parser = new yal2jvm(f);

		astRoot = parser.Module();

		//System.out.print("Error count: " + error_counter + "\n\n");
		
		//System.out.println("AST:");
		//node.dump("");

		buildSymbolTable(astRoot);

		System.out.print("\n\n\n");
	}
}

PARSER_END(yal2jvm)

SKIP : {
	" "
	| "\t"
	| "\n"
	| "\r"
	| <"//" (~["\n","\r"])* ("\n" | "\r" | "\r\n")>
	| <"/*" (~["*"])* "*" ("*" | ~["*","/"] (~["*"])* "*")* "/">
}

/* reserved words */
TOKEN : {
	<RELA_OP: ">" | "<" | "<=" | ">=" | "==" | "!=">
	| <ADDSUB_OP: "+" | "-">
	| <ARITH_OP: "*" | "/" | "<<" | ">>" | ">>>">
	| <BITWISE_OP: "&" | "|" | "^">
	| <NOT_OP: "!">
	| <WHILE: "while">
	| <IF: "if">
	| <ELSE: "else">
	| <ASSIGN: "=">
	| <ASPA: "\"">
	| <LPAR: "(">
	| <RPAR: ")">
	| <VIRG: ",">
	| <PVIRG: ";">
	| <LCHAVETA: "{">
	| <RCHAVETA: "}">
	| <FUNCTION: "function">
	| <MODULE: "module">
	| <SIZE: "size">
}

TOKEN : {
	<INTEGER: (<DIGIT>)+>
	| <ID: <LETTER> (<LETTER> | <DIGIT>)*>
	| <#LETTER: ["$","A"-"Z","_","a"-"z"]>
	| <#DIGIT: ["0"-"9"]>
	| <STRING: "\"" (["a"-"z","A"-"Z","0"-"9",":"," ","="])+ "\"">
}

SimpleNode Module() : {Token t;}{
	try{
		<MODULE> t=<ID>{jjtThis.jjtSetValue(t.image);} <LCHAVETA> (Declaration())* (Function())* <RCHAVETA>
	}
	catch (ParseException e) {
			System.out.println("EXCEPTION IN MODULE " + e.toString());
			yal2jvm.error_counter++;
			int[] kinds = {RCHAVETA, EOF};
			error_skipto(kinds);
	}
	{return jjtThis;}
}

void Declaration() : {Token t;}{
	t=<ID>{jjtThis.jjtSetValue(t.image);} ["[" "]"] [<PVIRG>]
	[
		<ASSIGN>
		try{
			(("[" ArraySize() "]") | [<ADDSUB_OP>] <INTEGER>) <PVIRG>
		}
		catch (ParseException e) {
			System.out.println("EXCEPTION IN DECLARATION " + e.toString());
			yal2jvm.error_counter++;
			int[] kinds = {PVIRG};
			error_skipto(kinds);
		}
	]
}

void Function() : {Token t;}{

	try{
		<FUNCTION> t=<ID>{jjtThis.jjtSetValue(t.image);}
	}
	catch (ParseException e) {
			System.out.println("EXCEPTION IN FUNCTION " + e.toString());
			yal2jvm.error_counter++;
			int[] kinds = {PVIRG, LCHAVETA, LPAR, ID};
			error_skipto(kinds);
	}

	try{
		[["[" "]"] <ASSIGN> <ID>] <LPAR> [Varlist()] <RPAR>
	}
	catch (ParseException e) {
			System.out.println("EXCEPTION IN FUNCTION " + e.toString());
			yal2jvm.error_counter++;
			int[] kinds = {RPAR};
			error_skipto(kinds);
	}
	<LCHAVETA> Stmtlst() <RCHAVETA>
}

void Varlist() : {}{
	(ArrayElement2()) ( <VIRG> ArrayElement2() )*
}

void ArrayElement() : {Token t;}
{
	t=<ID>{jjtThis.jjtSetValue(t.image);} "[" "]"
}

void ArrayElement2() : {Token t;}
{
	t=<ID>{jjtThis.jjtSetValue(t.image);} ["[" "]"]
}

void ScalarElement() : {Token t;}
{
	t=<ID>{jjtThis.jjtSetValue(t.image);}
}

void Stmtlst() : {}
{
	( Stmt() )*
} 

void SpecialStmtlst() #void : {}
{
	Stmtlst() <RCHAVETA>
} 

void Stmt() : {}
{
	try{
		If() | While() | LOOKAHEAD(3) Assign() | Callstmt()
	}
	catch (ParseException e) {
		System.out.println("EXCEPTION IN STMT " + e.toString());
		yal2jvm.error_counter++;
		int[] kinds = {RPAR, PVIRG, LCHAVETA};
		error_skipto(kinds);
	}
}

void Assign() : {}
{
	Lhs() <ASSIGN>
	try{
		Rhs() <PVIRG>
	}
	catch (ParseException e) {
		System.out.println("EXCEPTION IN ASSIGN " + e.toString());
		yal2jvm.error_counter++;
		int[] kinds = {PVIRG};
		error_skipto(kinds);
	}
}

void Lhs() : {Token t;}
{
	t=<ID>{jjtThis.jjtSetValue(t.image);} (("[" Index() "]")|(["." <SIZE>]))
}

void Rhs() : {}
{
	(Term() [(<ARITH_OP> | <BITWISE_OP> | <ADDSUB_OP>) Term()]) | "[" ArraySize() "]"
}

void ArraySize() : {}
{
	ScalarAccess() | <INTEGER>
}

void Term() : {Token t;}
{
	[<ADDSUB_OP>] (<INTEGER> | LOOKAHEAD(3) Call() | (t=<ID>{jjtThis.jjtSetValue(t.image);} (("[" Index() "]")|(["." <SIZE>]))))
}

void Exprtest() : {}
{
	try{
		<LPAR> Lhs() <RELA_OP> Rhs() <RPAR>
	}
	catch (ParseException e) {
		System.out.println("EXCEPTION IN EXPRTEST " + e.toString());
		yal2jvm.error_counter++;
		int[] kinds = {RPAR};
		error_skipto(kinds);
	}	
}

void While() : {}
{
	<WHILE> Exprtest() <LCHAVETA> Stmtlst() <RCHAVETA>
}

void If() : {}
{
	<IF> Exprtest() <LCHAVETA> Stmtlst() <RCHAVETA> 

	try{
		[<ELSE> <LCHAVETA> Stmtlst() <RCHAVETA>]
	}
	catch (ParseException e) {
		System.out.println("EXCEPTION IN ELSE " + e.toString());
		yal2jvm.error_counter++;
		int[] kinds = {PVIRG};
		error_skipto(kinds);
	}
}

void Call() : {Token t1, t2;}
{
	t1=<ID>{jjtThis.jjtSetValue(t1.image);} ["." t2=<ID>{jjtThis.jjtSetSecValue(t2.image);}] <LPAR>	

	try{
		[ArgumentList()] <RPAR>
	}
	catch (ParseException e) {
		System.out.println("EXCEPTION IN CALL " + e.toString());
		yal2jvm.error_counter++;
		int[] kinds = {RCHAVETA, LCHAVETA, RPAR};
		int ret = error_skipto(kinds);
		if(ret == LCHAVETA){
			SpecialStmtlst();
		}
	}
}

void Callstmt() #Call : {Token t1, t2;}
{
	t1=<ID>{jjtThis.jjtSetValue(t1.image);} ["." t2=<ID>{jjtThis.jjtSetSecValue(t2.image);}] <LPAR>	

	try{
		[ArgumentList()] <RPAR> <PVIRG>
	}
	catch (ParseException e) {
		System.out.println("EXCEPTION IN CALL " + e.toString());
		yal2jvm.error_counter++;
		int[] kinds = {PVIRG, RCHAVETA, LCHAVETA};
		int ret = error_skipto(kinds);
		if(ret == LCHAVETA){
			SpecialStmtlst();
		}
	}
}

void ArgumentList() : {}
{
	Argument() ( <VIRG> Argument() )*
}

void Argument() : {Token t;}
{
	( t=<ID>{jjtThis.jjtSetValue(t.image);} | t=<STRING>{jjtThis.jjtSetValue(t.image);} | t=<INTEGER>{jjtThis.jjtSetValue(t.image);} )
}

void ArrayAccess() : {Token t;}
{
	t=<ID>{jjtThis.jjtSetValue(t.image);} "[" Index() "]"
}

void ScalarAccess() : {Token t, t1;}
{
	t=<ID>{jjtThis.jjtSetValue(t.image);} ["." t1=<SIZE>{jjtThis.jjtSetSecValue(t1.image);}]
}

void Index() : {Token t;}
{
	t=<ID>{jjtThis.jjtSetValue(t.image);} | t=<INTEGER>{jjtThis.jjtSetValue(t.image);}
}

JAVACODE
int error_skipto(int[] kinds) #void {
  Token t;
  boolean exit = false;
  System.out.print("Tokens skipped: ");
  do {
  	t = getNextToken();
  	System.out.print(t + " ");
  	for(int a : kinds){
  		if((a == t.kind) | (t.kind == EOF))
  			exit = true;
  	}
  } while (!exit);
  System.out.print("\n\n");
  return t.kind;
}

JAVACODE
boolean buildSymbolTable(SimpleNode astRoot){

	SimpleNode moduleNode = astRoot;
	ArrayList<String> errors = new ArrayList<String>();
	ArrayList<SimpleNode> functions = new ArrayList<SimpleNode>();
	ArrayList<SimpleNode> declarations = new ArrayList<SimpleNode>();
	ArrayList<SimpleNode> local_vars = new ArrayList<SimpleNode>();

	getChildren(astRoot, errors, functions, declarations, local_vars);

	for(SimpleNode s : functions){
		getChildren(s, functions, declarations, local_vars);
	}

	for(SimpleNode s : declarations){
		getChildren(s, functions, declarations, local_vars);
	}

	System.out.println("@modules");
	System.out.println(moduleNode + "\n");

	System.out.println("@functions");
	for(SimpleNode s : functions){
		System.out.println(s);
	}

	System.out.println("\n@global variables");
	for(SimpleNode s : declarations){
		System.out.println(s);
	}

	System.out.println("\n@errors");
	for(String s : errors){
		System.out.println(s);
	}


	return true;
}

JAVACODE
void getChildren(SimpleNode parent, ArrayList<SimpleNode> errors, ArrayList<SimpleNode> functions, ArrayList<SimpleNode> declarations){
	ArrayList<SimpleNode> return = new ArrayList<SimpleNode>();
	for(int i = 0; i < parent.jjtGetNumChildren(); i++){
		if(parent.jjtGetChild(i).getId() == yal2jvmTreeConstants.JJTFUNCTION){
			if(!checkDuplicates(functions,(SimpleNode)parent.jjtGetChild(i)))
				functions.add((SimpleNode)parent.jjtGetChild(i));
			else{
				errors.add("Semantic error: node \"" + parent.jjtGetChild(i) + "\" is duplicate.");
			}
		}
		else if(parent.jjtGetChild(i).getId() == yal2jvmTreeConstants.JJTDECLARATION){
			if(!checkDuplicates(declarations,(SimpleNode)parent.jjtGetChild(i)))
				declarations.add((SimpleNode)parent.jjtGetChild(i));
			else{
				errors.add("Semantic error: node \"" + parent.jjtGetChild(i) + "\" is duplicate.");
			}
		}
	}
}

JAVACODE
boolean checkDuplicates(ArrayList<SimpleNode> nodes, SimpleNode node){
	for(SimpleNode n : nodes){
		if(n.jjtGetValue().equals(node.jjtGetValue())){
			System.out.println("dup " + node.jjtGetValue());
			return true;
		}
	}
	return false;
}